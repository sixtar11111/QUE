
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº’åŠ©é—®å·æ± </title>
    <style>
        /* è¿™é‡Œè¿˜æ˜¯ç”¨ä¹‹å‰çš„æ ·å¼ï¼Œæˆ–è€…ä½ è‡ªå·±ç¾åŒ–ä¸€ä¸‹ */
        body {
            font-family: sans-serif;
            text-align: center;
            padding: 20px;
            background: #f4f6f8;
        }

        .box {
            background: white;
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        input {
            padding: 10px;
            width: 70%;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            padding: 10px 20px;
            background: #0052d9;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

            button:disabled {
                background: #ccc;
            }

        .task-item {
            background: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            margin-top: 10px;
            border-radius: 8px;
            text-align: left;
        }

        .task-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn-check {
            background: #2ba471;
            display: none;
        }
        /* é»˜è®¤éšè—ç¡®è®¤æŒ‰é’® */
    </style>
</head>
<body>
    <div class="box">
        <h1>âš–ï¸ ç§¯åˆ†åˆ¶äº’å¡«</h1>
        <p>è¯·å…ˆå‘é€é“¾æ¥ï¼Œéšåé¢†å–é“¾æ¥ï¼Œæ¯å¡«å®Œä¸€ä¸ªï¼Œä½ çš„é“¾æ¥ç§¯åˆ†+1ï¼Œç§¯åˆ†è¶Šé«˜ï¼Œä½ çš„é“¾æ¥ç»™å…¶ä»–äººæŠ¥å‘Šçš„æ¦‚è®ºä¹Ÿå°±è¶Šå¤§ã€‚</p>

        <input type="url" id="myUrl" placeholder="è¾“å…¥ä½ çš„é—®å·é“¾æ¥">
        <button onclick="getTasks()" id="mainBtn">å¼€å§‹äº’å¡«</button>

        <div id="taskList"></div>
    </div>

    <script>
    let myCurrentUrl = "";

    async function getTasks() {
        const urlInput = document.getElementById('myUrl');
        const list = document.getElementById('taskList');
        const mainBtn = document.getElementById('mainBtn');
        
        if (!urlInput.value) return alert("è¯·è¾“å…¥ä½ çš„é“¾æ¥");
        
        // ç®€å•ç½‘å€æ ¡éªŒ
        if (!urlInput.value.startsWith('http')) {
            return alert("é“¾æ¥å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´");
        }

        myCurrentUrl = urlInput.value;
        mainBtn.disabled = true;
        list.innerHTML = "<p>æ­£åœ¨åŒ¹é…æœ€æ–°é—®å·...</p>";

        try {
            // 1. è¯·æ±‚åç«¯è·å–ä»»åŠ¡
            const res = await fetch('/exchange', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ url: myCurrentUrl })
            });

            // æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å“åº”æ­£å¸¸
            if (!res.ok) throw new Error("æœåŠ¡å™¨å“åº”å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•");

            const data = await res.json();

            // --- æ ¸å¿ƒä¿®å¤å¼€å§‹ï¼šé˜²å¾¡æ€§åˆ¤æ–­ ---
            list.innerHTML = "";

            // A. åˆ¤æ–­æ˜¯å¦æœ‰æŠ¥é”™ä¿¡æ¯
            if (data.error) {
                list.innerHTML = `<p style="color:red; background:#fff1f0; padding:10px; border-radius:5px;">
                    âŒ åŒ¹é…å¤±è´¥ï¼š${data.error}<br>
                    <small>æç¤ºï¼šè¯·ç¡®ä¿ä½ å·²åœ¨ Supabase è¿è¡Œäº†æœ€æ–°çš„ SQL ä»£ç ã€‚</small>
                </p>`;
                return;
            }

            // B. åˆ¤æ–­è¿”å›çš„æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡® (å¿…é¡»æœ‰ links ä¸”å¿…é¡»æ˜¯æ•°ç»„)
            if (!data.links || !Array.isArray(data.links)) {
                console.error("æ”¶åˆ°é”™è¯¯æ ¼å¼çš„æ•°æ®:", data);
                list.innerHTML = "<p style='color:orange'>âš ï¸ æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨ F12 æ§åˆ¶å°æ—¥å¿—ã€‚</p>";
                return;
            }

            // C. åˆ¤æ–­æ˜¯å¦æ²¡æœ‰ä»»åŠ¡
            if (data.links.length === 0) {
                list.innerHTML = `<div style="padding:20px; color:#666;">
                    <p>ğŸ‰ ä½ çš„é“¾æ¥å·²æ”¶å½•ï¼</p>
                    <p>ä½†ç›®å‰æ± å­é‡Œæ²¡æœ‰å…¶ä»–é—®å·ï¼Œä½ æ˜¯ç¬¬ä¸€ä¸ªã€‚<br>è¯·ç¨åå›æ¥ï¼Œç­‰åˆ«äººä¸Šä¼ åï¼Œä½ ä¼šä¼˜å…ˆå‡ºç°åœ¨ä»–ä»¬çš„åˆ—è¡¨é‡Œã€‚</p>
                </div>`;
                return;
            }

            // D. æ ¼å¼æ²¡é—®é¢˜ï¼Œå¼€å§‹æ¸²æŸ“åˆ—è¡¨
           data.links.forEach(item => {
    const div = document.createElement('div');
    div.className = 'task-item';
    
    // æ³¨æ„ï¼šè¿™é‡Œçš„ item.id å˜æˆäº† item.r_idï¼Œitem.url å˜æˆäº† item.r_url
    div.innerHTML = `
        <div style="margin-bottom:8px;"><b>ğŸ“„ é—®å·ä»»åŠ¡ #${item.r_id}</b></div>
        <div class="task-actions">
            <a href="${item.r_url}" target="_blank" onclick="showConfirm(this)">
                <button style="background:#0052d9;">ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€é—®å·</button>
            </a>
            <button class="btn-check" onclick="confirmTask(${item.r_id}, this)" style="background:#2ba471; display:none;">ç¬¬äºŒæ­¥ï¼šå·²å¡«å®Œï¼Œé¢†ç§¯åˆ†</button>
        </div>
    `;
    list.appendChild(div);
});
            // --- æ ¸å¿ƒä¿®å¤ç»“æŸ ---

        } catch (e) {
            list.innerHTML = `<p style="color:red">ç³»ç»Ÿé”™è¯¯: ${e.message}</p>`;
        } finally {
            mainBtn.disabled = false;
        }
    }

    // åªæœ‰ç‚¹å‡»äº†é“¾æ¥ï¼Œæ‰æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
    function showConfirm(el) {
        // æ‰¾åˆ° a æ ‡ç­¾åŒçº§çš„é‚£ä¸ªç¡®è®¤æŒ‰é’®
        const confirmBtn = el.parentElement.querySelector('.btn-check');
        if (confirmBtn) confirmBtn.style.display = 'inline-block';
    }

    // ç¡®è®¤åŠ åˆ†
    async function confirmTask(targetId, btn) {
        const originalText = btn.innerText;
        btn.innerText = "å¤„ç†ä¸­...";
        btn.disabled = true;

        try {
            const res = await fetch('/confirm', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    my_url: myCurrentUrl, 
                    target_id: targetId 
                })
            });

            if (!res.ok) throw new Error("åŠ åˆ†å¤±è´¥");

            btn.innerText = "å·²å®Œæˆ (+1åˆ†)";
            btn.style.background = "#ccc";
            btn.style.cursor = "default";
            
        } catch (e) {
            alert("æ“ä½œå¤±è´¥: " + e.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>
</body>
</html>


